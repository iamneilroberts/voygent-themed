# VoyGent Database Schema

**Database**: `voygent-themed` (Production) / `voygent-test` (Testing)
**Database ID**: 62077781-9458-4206-a5c6-f38dc419e599 (Production)
**Platform**: Cloudflare D1 (SQLite)
**Last Updated**: 2025-10-07

---

## Table of Contents

1. [Core Trip Tables](#core-trip-tables)
2. [Template Management](#template-management)
3. [Agency & White-Label](#agency--white-label)
4. [Caching](#caching)
5. [Logging & Monitoring](#logging--monitoring)
6. [Relationships](#relationships)
7. [Common Queries](#common-queries)

---

## Core Trip Tables

### `themed_trips`
Main table for all trip records across all themes (heritage, TV/movie, historical, culinary, adventure, etc.)

**Columns:**
```sql
id                  TEXT PRIMARY KEY           -- UUID v4
user_id             TEXT                       -- User identifier (can be anonymous)
template            TEXT DEFAULT 'heritage'    -- Theme: heritage|tvmovie|historical|culinary|adventure|etc
title               TEXT                       -- User-provided or auto-generated trip title
intake_json         TEXT                       -- JSON: User input (surnames, origins, duration, etc)
options_json        TEXT                       -- JSON: 2-4 trip options generated by AI
itinerary_json      TEXT                       -- JSON: Detailed itinerary after user selects option
variants_json       TEXT                       -- JSON: A/B variants (luxury, transport, etc)
status              TEXT DEFAULT 'intake'      -- intake|researching|options_ready|selected|booked
agency_id           TEXT                       -- FK to agencies (for white-label routing)
handoff_json        TEXT                       -- JSON: Complete traveler data for pro handoff
progress_step       TEXT DEFAULT 'intake'      -- Current step: intake|research|generate|complete
progress_message    TEXT DEFAULT 'Starting...' -- User-facing progress message
progress_percent    INTEGER DEFAULT 0          -- Progress 0-100%
created_at          INTEGER DEFAULT (unixepoch())
updated_at          INTEGER DEFAULT (unixepoch())
```

**Indexes:**
- `idx_heritage_trips_user` on `(user_id)`
- `idx_heritage_trips_created` on `(created_at DESC)`

**Status Flow:**
```
intake → researching → options_ready → selected → booked
```

**Sample intake_json:**
```json
{
  "surnames": ["McLeod", "Roberts"],
  "origins": ["Scotland", "Wales"],
  "adults": 2,
  "children": 0,
  "duration": 7,
  "month": "2025-06",
  "departure_airport": "JFK",
  "luxury": "comfort",
  "activity": "moderate"
}
```

---

### `themed_messages`
Tracks AI messages and token usage per trip (for cost accounting).

**Columns:**
```sql
id              TEXT PRIMARY KEY
trip_id         TEXT NOT NULL              -- FK to themed_trips.id
role            TEXT NOT NULL              -- 'system'|'user'|'assistant'
content         TEXT                       -- Message content
tokens_in       INTEGER DEFAULT 0          -- Input tokens
tokens_out      INTEGER DEFAULT 0          -- Output tokens
cost_usd        REAL DEFAULT 0.0           -- Cost in USD
created_at      INTEGER DEFAULT (unixepoch())

FOREIGN KEY (trip_id) REFERENCES themed_trips(id)
```

**Indexes:**
- `idx_heritage_messages_trip` on `(trip_id, created_at)`

**Example Query:**
```sql
-- Get total cost for a trip
SELECT trip_id, SUM(cost_usd) as total_cost, SUM(tokens_in + tokens_out) as total_tokens
FROM themed_messages
WHERE trip_id = 'abc123'
GROUP BY trip_id;
```

---

## Template Management

### `trip_templates`
Stores editable theme configurations for admin dashboard. Defines how each trip type behaves.

**Columns:**
```sql
id                          TEXT PRIMARY KEY      -- 'heritage'|'tvmovie'|'historical'|'culinary'|'adventure'|etc
name                        TEXT NOT NULL         -- "Heritage Travel" | "TV & Film Locations"
description                 TEXT NOT NULL         -- User-facing description
icon                        TEXT NOT NULL         -- Emoji icon (🏰, 🎬, 📜, 🍷, 🏔️)
intake_prompt               TEXT NOT NULL         -- AI prompt for normalizing user intake
options_prompt              TEXT NOT NULL         -- AI prompt for generating 2-4 trip options
required_fields             TEXT NOT NULL         -- JSON array: ["surnames", "origins"]
optional_fields             TEXT NOT NULL         -- JSON array: ["genealogy_url", "duration"]
example_inputs              TEXT NOT NULL         -- JSON: Sample inputs for this theme
research_synthesis_prompt   TEXT                  -- Prompt for synthesizing web research into summary
research_query_template     TEXT                  -- Template for web search query: "{input} surname origin"
is_active                   INTEGER DEFAULT 1     -- 1 = active, 0 = hidden
created_at                  INTEGER DEFAULT (unixepoch())
updated_at                  INTEGER DEFAULT (unixepoch())
```

**Indexes:**
- `idx_trip_templates_active` on `(is_active, name)`

**Usage:**
1. Admin creates/edits templates via dashboard
2. Frontend fetches templates via `/api/templates`
3. User selects template, fills intake form
4. Backend uses template prompts to generate trip

**Example:**
```sql
SELECT id, name, icon, is_active FROM trip_templates WHERE is_active = 1 ORDER BY name;
```

---

## Agency & White-Label

### `agencies`
White-label agencies that can customize branding and route trips to their travel agents.

**Columns:**
```sql
id              TEXT PRIMARY KEY
name            TEXT NOT NULL              -- "Smith Travel Agency"
custom_domain   TEXT UNIQUE                -- "travel.smithagency.com"
logo_url        TEXT                       -- URL to agency logo
primary_color   TEXT DEFAULT '#667eea'     -- CSS color
accent_color    TEXT DEFAULT '#764ba2'     -- CSS color
contact_email   TEXT                       -- Agency contact
contact_phone   TEXT                       -- Agency phone
created_at      INTEGER DEFAULT (unixepoch())
updated_at      INTEGER DEFAULT (unixepoch())
```

**Relationships:**
- One agency has many `themed_trips` (via `themed_trips.agency_id`)
- One agency has many `admin_users` (agency admins)

**Use Case:**
```sql
-- Find all trips for a specific agency
SELECT t.id, t.title, t.status, t.created_at
FROM themed_trips t
WHERE t.agency_id = 'agency-123'
ORDER BY t.created_at DESC;
```

---

### `admin_users`
Admin dashboard authentication (supports super admins and agency-scoped admins).

**Columns:**
```sql
id              TEXT PRIMARY KEY
email           TEXT NOT NULL UNIQUE
password_hash   TEXT NOT NULL              -- bcrypt hash
role            TEXT NOT NULL              -- 'super_admin'|'agency_admin'
agency_id       TEXT                       -- NULL for super_admin, required for agency_admin
created_at      INTEGER DEFAULT (unixepoch())
last_login      INTEGER

FOREIGN KEY (agency_id) REFERENCES agencies(id) ON DELETE CASCADE
```

**Indexes:**
- `idx_admin_email` on `(email)`
- `idx_admin_agency` on `(agency_id)`

**Access Control:**
- **super_admin**: Can see all trips, all agencies, all logs
- **agency_admin**: Can only see trips/logs for their `agency_id`

---

## Caching

### `cache_providers`
Caches external API responses (Amadeus, Kiwi, Serper, Tavily) to reduce costs and latency.

**Columns:**
```sql
id              TEXT PRIMARY KEY
provider        TEXT NOT NULL              -- 'amadeus'|'kiwi'|'serper'|'tavily'
query_hash      TEXT NOT NULL              -- SHA-256 of normalized params
query_params    TEXT NOT NULL              -- JSON: Original query params (for debugging)
response_json   TEXT NOT NULL              -- Cached API response
ttl_seconds     INTEGER NOT NULL           -- 86400 (24h flights/hotels) | 604800 (7d search)
created_at      INTEGER DEFAULT (unixepoch())

UNIQUE(provider, query_hash)
```

**Indexes:**
- `idx_cache_lookup` on `(provider, query_hash, created_at)` — Fast cache hits
- `idx_cache_expiry` on `(created_at, ttl_seconds)` — Cleanup expired entries

**Cache Logic:**
1. Hash normalized query params (e.g., `JFK→EDI 2025-06 adults=2`)
2. Check: `WHERE provider='amadeus' AND query_hash='abc123' AND created_at + ttl_seconds > unixepoch()`
3. If hit: return cached response
4. If miss: call API, store response

**Cleanup Query:**
```sql
-- Delete expired cache entries
DELETE FROM cache_providers
WHERE created_at + ttl_seconds < unixepoch();
```

---

## Logging & Monitoring

### `logs`
Structured log entries for all operations (API calls, errors, research, trip generation).

**Columns:**
```sql
id              TEXT PRIMARY KEY
request_id      TEXT NOT NULL              -- UUID per HTTP request
correlation_id  TEXT                       -- Groups related operations (e.g., trip generation)
timestamp       INTEGER NOT NULL           -- unixepoch
severity        TEXT NOT NULL              -- 'DEBUG'|'INFO'|'WARN'|'ERROR'|'CRITICAL'
operation       TEXT NOT NULL              -- 'create_trip'|'research_execute'|'amadeus_call'
message         TEXT NOT NULL              -- Human-readable log message
metadata        TEXT                       -- JSON: Additional context
duration_ms     INTEGER                    -- Operation duration
status          TEXT                       -- 'success'|'failure'|'timeout'
agency_id       TEXT                       -- For agency-scoped filtering
endpoint        TEXT                       -- '/api/trips'|'/api/providers/flights'

FOREIGN KEY (agency_id) REFERENCES agencies(id) ON DELETE SET NULL
```

**Indexes:**
- `idx_logs_timestamp` on `(timestamp DESC)` — Recent logs
- `idx_logs_request_id` on `(request_id)` — Trace single request
- `idx_logs_correlation_id` on `(correlation_id)` — Group related operations
- `idx_logs_endpoint_timestamp` on `(endpoint, timestamp DESC)`
- `idx_logs_severity_timestamp` on `(severity, timestamp DESC)` — Errors first
- `idx_logs_agency_timestamp` on `(agency_id, timestamp DESC)` — Agency filtering

**Example Queries:**
```sql
-- Recent errors
SELECT * FROM logs WHERE severity IN ('ERROR', 'CRITICAL') ORDER BY timestamp DESC LIMIT 50;

-- Trace a single request
SELECT * FROM logs WHERE request_id = 'req-abc123' ORDER BY timestamp ASC;

-- Slow operations
SELECT operation, AVG(duration_ms), COUNT(*) FROM logs
WHERE duration_ms > 1000
GROUP BY operation ORDER BY AVG(duration_ms) DESC;
```

---

### `metrics_snapshots`
Pre-aggregated 5-minute metrics for real-time dashboard (RPM, error rate, avg response time).

**Columns:**
```sql
id              TEXT PRIMARY KEY
timestamp       INTEGER NOT NULL           -- Start of 5-min window
rpm             INTEGER NOT NULL DEFAULT 0 -- Requests per minute
error_rate      REAL NOT NULL DEFAULT 0.0  -- 0.0 - 1.0
avg_response_ms INTEGER NOT NULL DEFAULT 0
active_requests INTEGER NOT NULL DEFAULT 0 -- Concurrent requests
agency_id       TEXT

FOREIGN KEY (agency_id) REFERENCES agencies(id) ON DELETE CASCADE
```

**Indexes:**
- `idx_metrics_timestamp` on `(timestamp DESC)`
- `idx_metrics_agency_timestamp` on `(agency_id, timestamp DESC)`

**Usage:**
```sql
-- Last hour of RPM
SELECT timestamp, rpm FROM metrics_snapshots
WHERE timestamp > unixepoch() - 3600
ORDER BY timestamp DESC;
```

---

### `daily_aggregates`
Daily rollups for long-term analytics (kept indefinitely).

**Columns:**
```sql
id                      TEXT PRIMARY KEY
date                    TEXT NOT NULL UNIQUE   -- 'YYYY-MM-DD'
total_requests          INTEGER NOT NULL DEFAULT 0
total_errors            INTEGER NOT NULL DEFAULT 0
total_cost_usd          REAL NOT NULL DEFAULT 0.0
avg_response_ms         INTEGER NOT NULL DEFAULT 0
p95_response_ms         INTEGER NOT NULL DEFAULT 0
p99_response_ms         INTEGER NOT NULL DEFAULT 0
provider_breakdown_json TEXT                   -- JSON: Cost by provider
endpoint_breakdown_json TEXT                   -- JSON: Requests by endpoint
agency_id               TEXT

FOREIGN KEY (agency_id) REFERENCES agencies(id) ON DELETE CASCADE
```

**Indexes:**
- `idx_daily_date` on `(date DESC)`
- `idx_daily_agency_date` on `(agency_id, date DESC)`

**Example:**
```sql
-- Monthly cost
SELECT SUM(total_cost_usd) FROM daily_aggregates WHERE date LIKE '2025-06%';
```

---

## Relationships

```
agencies
  ├─→ themed_trips (agency_id)
  ├─→ admin_users (agency_id)
  ├─→ logs (agency_id)
  ├─→ metrics_snapshots (agency_id)
  └─→ daily_aggregates (agency_id)

themed_trips
  └─→ themed_messages (trip_id)

trip_templates
  └─→ themed_trips (template field reference)
```

---

## Common Queries

### Get all active templates
```sql
SELECT id, name, icon, description FROM trip_templates WHERE is_active = 1 ORDER BY name;
```

### Create a new trip
```sql
INSERT INTO themed_trips (id, user_id, template, intake_json, status)
VALUES ('trip-abc123', 'user-456', 'heritage', '{"surnames":["Smith"]}', 'intake');
```

### Get trips for a user
```sql
SELECT id, title, template, status, created_at FROM themed_trips
WHERE user_id = 'user-456'
ORDER BY created_at DESC LIMIT 20;
```

### Get trip with messages
```sql
SELECT t.*,
       json_group_array(json_object(
         'role', m.role,
         'tokens_in', m.tokens_in,
         'tokens_out', m.tokens_out,
         'cost_usd', m.cost_usd
       )) as messages
FROM themed_trips t
LEFT JOIN themed_messages m ON m.trip_id = t.id
WHERE t.id = 'trip-abc123'
GROUP BY t.id;
```

### Check cache hit
```sql
SELECT response_json FROM cache_providers
WHERE provider = 'amadeus'
  AND query_hash = 'sha256hash'
  AND created_at + ttl_seconds > unixepoch()
LIMIT 1;
```

### Recent errors (last 24h)
```sql
SELECT timestamp, operation, message, metadata FROM logs
WHERE severity IN ('ERROR', 'CRITICAL')
  AND timestamp > unixepoch() - 86400
ORDER BY timestamp DESC;
```

### Trip generation performance
```sql
SELECT
  date(created_at, 'unixepoch') as day,
  template,
  COUNT(*) as trips_created,
  AVG(CAST((julianday(updated_at, 'unixepoch') - julianday(created_at, 'unixepoch')) * 86400 AS INTEGER)) as avg_duration_sec
FROM themed_trips
WHERE status IN ('options_ready', 'selected', 'booked')
GROUP BY day, template
ORDER BY day DESC;
```

### Top cost drivers
```sql
SELECT
  t.template,
  COUNT(*) as trip_count,
  SUM(m.cost_usd) as total_cost,
  AVG(m.cost_usd) as avg_cost_per_trip
FROM themed_trips t
JOIN themed_messages m ON m.trip_id = t.id
WHERE t.created_at > unixepoch() - 2592000  -- Last 30 days
GROUP BY t.template
ORDER BY total_cost DESC;
```

---

## Migration History

| Migration | File | Purpose |
|-----------|------|---------|
| 001 | `001_init.sql` | Initial trips + messages tables |
| 002 | `002_heritage_tables.sql` | Heritage-specific tables (deprecated) |
| 003 | `003_cache_providers.sql` | API response caching |
| 004 | `004_trip_templates.sql` | Template management |
| 007 | `007_rename_heritage_tables.sql` | Renamed to `themed_*` |
| 008 | `008_add_white_label.sql` | Agency support |
| 009 | `009_add_research_prompts.sql` | Research synthesis prompts |
| 013 | `013_add_logging_tables.sql` | Logging, metrics, admin users |
| 014 | `014_add_progress_tracking.sql` | Real-time progress updates |

---

## Schema Diagram

```
┌─────────────────┐       ┌─────────────────┐
│  agencies       │◄──────┤  admin_users    │
└────────┬────────┘       └─────────────────┘
         │
         │ agency_id
         │
┌────────▼────────┐       ┌─────────────────┐
│  themed_trips   │◄──────┤ themed_messages │
└────────┬────────┘       └─────────────────┘
         │                        trip_id
         │ template
         │
┌────────▼────────┐
│ trip_templates  │
└─────────────────┘

┌─────────────────┐       ┌─────────────────┐
│ cache_providers │       │      logs       │
└─────────────────┘       └─────────────────┘

┌─────────────────┐       ┌─────────────────┐
│metrics_snapshots│       │daily_aggregates │
└─────────────────┘       └─────────────────┘
```

---

## Best Practices

### For Coding Agents

1. **Always use parameterized queries** to prevent SQL injection
2. **Use transactions** for multi-table operations (trips + messages)
3. **Update `updated_at`** when modifying `themed_trips`
4. **Log all operations** to `logs` table with proper severity
5. **Check cache first** before calling external APIs
6. **Clean up expired cache** entries periodically (daily cron)
7. **Aggregate metrics** every 5 minutes → `metrics_snapshots`
8. **Roll up daily** metrics at midnight → `daily_aggregates`
9. **Respect agency boundaries** when querying (filter by `agency_id` for agency admins)

### Performance Tips

- Use `LIMIT` on large tables (`logs`, `themed_trips`)
- Leverage indexes (all FK columns are indexed)
- Avoid `SELECT *` on JSON-heavy columns (use specific columns)
- Use `json_extract()` for querying JSON columns
- Batch inserts when possible (messages, logs)

---

## Accessing the Database

### Local Development
```bash
npx wrangler d1 execute voygent-themed --local --command="SELECT COUNT(*) FROM themed_trips"
```

### Production
```bash
npx wrangler d1 execute voygent-themed --remote --command="SELECT COUNT(*) FROM themed_trips"
```

### Run Migration
```bash
npx wrangler d1 execute voygent-themed --local --file=migrations/XXX_migration.sql
npx wrangler d1 execute voygent-themed --remote --file=migrations/XXX_migration.sql
```

---

**For Questions**: See `wrangler.toml` for binding configuration, or check migration files in `migrations/` directory.
